#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

if [ ! -e "${DIR}/symfony" ] # -e detects both regular file and symlink
then
    if command -v symfony &> /dev/null
    then
        # use local symfony
        ln -s "$(which symfony)" "${DIR}"/symfony
    else
      # download symfony
      curl -sS https://get.symfony.com/cli/installer | bash -s -- --install-dir="${DIR}"
    fi
fi

if [ -z "${APP_ENV}" ] || [ "${APP_ENV}" != "test" ]
then
    ( >&2 echo -e "\033[33mAPP_ENV will be changed to 'test'\033[0m" 1>&2 )
fi

BEHAT_APP_ENV=${BEHAT_APP_ENV:=test}
BEHAT_APP_PORT=${BEHAT_APP_PORT:=8081}

SYMFONY_SERVER_START_COMMAND="APP_ENV=${BEHAT_APP_ENV} ${DIR}/symfony server:start --port=${BEHAT_APP_PORT:=8081} --dir=${DIR}/../tests/Application/public --daemon"

SYMFONY_SERVER_START_OUTPUT=$( bash -c "$SYMFONY_SERVER_START_COMMAND" 2>&1 )

SYMFONY_SERVER_CA_WARNING=$( echo "${SYMFONY_SERVER_START_OUTPUT}" | grep "WARNING" | grep --only-matching "server:ca:install" )

if [ -z "${SYMFONY_SERVER_CA_WARNING}" ]
then
  echo "${SYMFONY_SERVER_START_OUTPUT}"
else
  if command -v sudo &> /dev/null
  then
    sudo "${DIR}"/symfony server:ca:install
  else
    "${DIR}"/symfony server:ca:install
  fi

  APP_ENV="${BEHAT_APP_ENV}" "${DIR}"/symfony server:stop --dir="${DIR}"/../tests/Application/public 1>/dev/null

  bash -c "$SYMFONY_SERVER_START_COMMAND"
fi

( APP_ENV="${BEHAT_APP_ENV}" "${DIR}/behat" "$@" )
